{% extends 'base.html' %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    #nearby-map { height: 380px; width: 100%; }
    .map-status { margin-top: 10px; }
    .sos-btn { margin-top: 10px; }
    .view-all-btn { margin-top: 10px; }
    .awareness-banner {
        display: flex;
        align-items: center;
        gap: 14px;
        background: #f0fff4;
        border: 1px solid #d9f9e1;
        border-left: 5px solid #28a745;
        padding: 12px 16px;
        border-radius: 6px;
        margin: 10px 0 0;
        animation: pulseIn 1.2s ease;
    }
    .awareness-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #28a745;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        animation: heartbeat 1.6s ease-in-out infinite;
    }
    .awareness-text h4 {
        margin: 0 0 4px;
        font-weight: 700;
    }
    .awareness-text p {
        margin: 0;
        color: #2f5133;
    }
    @keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.08); }
    }
    @keyframes pulseIn {
        from { opacity: 0; transform: translateY(6px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="section-title">
            <h2>User Dashboard</h2>
            <p>Send an SOS request and view nearby hospitals.</p>
        </div>
        <div class="awareness-banner">
            <div class="awareness-icon"><i class="fa fa-heartbeat"></i></div>
            <div class="awareness-text">
                <h4>Awareness</h4>
                <p>Spread urgent donor needs through social media, organize easy-to-access donation drives, and share real stories to inspire action.</p>
                <p style="margin-top: 6px;">Educate people that donation is safe and quick, and encourage first-time and regular voluntary donors for a safer blood supply.</p>
            </div>
        </div>
    </div>
</div>

<div class="row" style="margin-bottom: 20px;">
    <div class="col-md-12 text-center">
        <button type="button" class="btn btn-primary btn-lg sos-btn" data-toggle="modal" data-target="#sosModal">
            <i class="fa fa-bell"></i> Send SOS
        </button>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <h3>My Requests</h3>
        <div class="patient-requests">
        {% for alert in alerts %}
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="row">
                        <div class="col-xs-6">
                            <strong>Blood:</strong> {{ alert.blood_type }}
                        </div>
                        <div class="col-xs-6 text-right">
                            <span class="label label-info">Donor: {{ alert.donor_status }}</span>
                            <span class="label label-default">Hospital: {{ alert.status }}</span>
                        </div>
                    </div>
                    <hr style="margin: 10px 0;">
                    <p style="margin: 0;"><strong>Patient:</strong> {{ alert.patient_name|default:"Unknown" }}</p>
                    <p style="margin: 0;"><strong>Reason:</strong> {{ alert.note|default:"-" }}</p>
                    <p style="margin: 0;"><strong>Hospital Status:</strong> {{ alert.status }}</p>
                    {% if alert.donor_responder %}
                        <p style="margin: 0;"><strong>Donor Response:</strong> {{ alert.donor_status }} by {{ alert.donor_responder.first_name|default:alert.donor_responder.username }}</p>
                    {% else %}
                        <p style="margin: 0;"><strong>Donor Response:</strong> waiting</p>
                    {% endif %}
                    <p style="margin: 10px 0 0;">
                        <a href="{% url 'patient_donors' alert.id %}" class="btn btn-default btn-sm">
                            View Donors For This Request
                        </a>
                        <button type="button" class="btn btn-primary btn-sm js-feedback-toggle" data-target-id="feedback-box-{{ alert.id }}">
                            Feedback
                        </button>
                    </p>
                    <div id="feedback-box-{{ alert.id }}" class="js-feedback-box" style="display:none; margin-top:10px;">
                        <form action="{% url 'save_sos_feedback' alert.id %}" method="post">
                            {% csrf_token %}
                            <div class="form-group" style="margin-bottom:8px;">
                                <textarea name="feedback" class="form-control" rows="3" placeholder="Write your feedback here..." required>{{ alert.feedback }}</textarea>
                            </div>
                            <button type="submit" class="btn btn-success btn-sm">Save Feedback</button>
                        </form>
                    </div>
                    {% if alert.feedback %}
                        <p style="margin: 8px 0 0;"><strong>Saved Feedback:</strong> {{ alert.feedback }}</p>
                    {% endif %}
                    <p style="margin: 0; color: #777;"><small>{{ alert.created_at|date:"M d, H:i" }}</small></p>
                </div>
            </div>
        {% empty %}
            <div class="alert alert-info">No active requests.</div>
        {% endfor %}
        </div>
        {% if alerts|length > 4 %}
            <p style="margin-top: 10px;">
                <button type="button" id="view-all-requests" class="btn btn-default btn-sm">View All Requests</button>
            </p>
        {% endif %}
    </div>

    <div class="col-md-6">
        <h3>Hospitals Near You (OSM)</h3>
        <div class="panel panel-default">
            <div class="panel-body">
                <div id="nearby-map"></div>
                <div class="clearfix map-status">
                    <button type="button" id="update-location-btn" class="btn btn-default btn-sm pull-left">
                        <i class="fa fa-crosshairs"></i> Update My Location
                    </button>
                    <div id="nearby-map-status" class="pull-right" style="padding-top: 6px; color: #777;">Fetching your location…</div>
                </div>
                <div id="nearby-hospitals-list" style="margin-top: 15px;"></div>
                <div class="view-all-btn">
                    <button type="button" id="view-all-hospitals" class="btn btn-default btn-sm" style="display:none;">View All</button>
                </div>
                {{ registered_hospitals_for_map|json_script:"registered-hospitals-for-map" }}
            </div>
        </div>
    </div>
</div>

<!-- SOS Modal (simple form) -->
<div class="modal fade" id="sosModal" tabindex="-1" role="dialog" aria-labelledby="sosModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form action="{% url 'submit_sos' %}" method="post" autocomplete="off">
                {% csrf_token %}
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="sosModalLabel">Broadcast SOS Alert</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Patient's Name (Who Needs Blood)</label>
                        <input type="text" name="patient_name" class="form-control" placeholder="Patient's name" required autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label>Required Blood Type</label>
                        <select name="blood_type" class="form-control" required>
                            <option value="" disabled selected>Select Type</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Condition / Note</label>
                        <textarea name="note" class="form-control" rows="4" placeholder="Critical condition, Ward No, Hospital Name..." required></textarea>
                    </div>
                    <p style="color:#777; margin:0;"><small>Location is attached automatically from your latest saved location.</small></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Alert</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    (function initRequestsToggle() {
        var requests = document.querySelectorAll('.patient-requests .panel');
        if (!requests.length) return;
        var btn = document.getElementById('view-all-requests');
        if (!btn) return;
        requests.forEach(function (panel, idx) {
            if (idx >= 4) panel.style.display = 'none';
        });
        btn.addEventListener('click', function () {
            requests.forEach(function (panel) { panel.style.display = 'block'; });
            btn.style.display = 'none';
        });
    })();

    (function initFeedbackToggle() {
        var buttons = document.querySelectorAll('.js-feedback-toggle');
        if (!buttons.length) return;
        buttons.forEach(function (btn) {
            btn.addEventListener('click', function () {
                var targetId = btn.getAttribute('data-target-id');
                var box = targetId ? document.getElementById(targetId) : null;
                if (!box) return;
                box.style.display = box.style.display === 'none' ? 'block' : 'none';
            });
        });
    })();

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    function haversineKm(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) ** 2;
        return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    async function fetchNearbyHospitals(lat, lon, radiusMeters) {
        const url = new URL('{% url "osm_nearby_hospitals" %}', window.location.origin);
        url.searchParams.set('latitude', String(lat));
        url.searchParams.set('longitude', String(lon));
        url.searchParams.set('radius', String(radiusMeters));
        const response = await fetch(url.toString(), { method: 'GET' });
        if (!response.ok) throw new Error(`Hospital lookup error: ${response.status}`);
        const data = await response.json();
        if (!data.ok) throw new Error(data.error || 'Hospital lookup failed');
        return (data.hospitals || []).map(h => ({
            id: h.id,
            name: h.name,
            lat: Number(h.latitude),
            lon: Number(h.longitude),
            address: h.address || ''
        })).filter(h => Number.isFinite(h.lat) && Number.isFinite(h.lon));
    }

    (function initNearbyMap() {
        const statusEl = document.getElementById('nearby-map-status');
        const listEl = document.getElementById('nearby-hospitals-list');
        const viewAllBtn = document.getElementById('view-all-hospitals');
        const updateBtn = document.getElementById('update-location-btn');
        const registeredEl = document.getElementById('registered-hospitals-for-map');
        const registeredHospitals = registeredEl ? JSON.parse(registeredEl.textContent || '[]') : [];

        const fallbackLat = Number('{{ user.latitude }}') || 28.6139;
        const fallbackLon = Number('{{ user.longitude }}') || 77.2090;

        const map = L.map('nearby-map').setView([fallbackLat, fallbackLon], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const patientMarker = L.marker([fallbackLat, fallbackLon]).addTo(map).bindPopup('You are here');
        const osmLayer = L.layerGroup().addTo(map);
        const registeredLayer = L.layerGroup().addTo(map);

        async function persistUserLocation(lat, lon) {
            const csrf = getCookie('csrftoken');
            if (!csrf) return;
            const body = new URLSearchParams({ latitude: String(lat), longitude: String(lon) });
            await fetch('{% url "update_location" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                    'X-CSRFToken': csrf
                },
                body
            });
        }

        async function loadHospitals(lat, lon) {
            statusEl.textContent = 'Loading hospitals within 1 km...';
            osmLayer.clearLayers();
            registeredLayer.clearLayers();
            listEl.innerHTML = '';

            try {
                const radius = 1000;
                const osmHospitals = await fetchNearbyHospitals(lat, lon, radius);
                const osmWithDistanceAll = osmHospitals
                    .map(h => ({ ...h, distanceKm: haversineKm(lat, lon, h.lat, h.lon) }))
                    .sort((a, b) => a.distanceKm - b.distanceKm);

                osmWithDistanceAll.forEach((h) => {
                    L.marker([h.lat, h.lon]).addTo(osmLayer).bindPopup(
                        `<strong>${h.name}</strong><br/>${h.address ? h.address + '<br/>' : ''}${h.distanceKm.toFixed(1)} km away`
                    );
                });

                const regWithDistance = registeredHospitals
                    .map(h => ({
                        ...h,
                        lat: Number(h.latitude),
                        lon: Number(h.longitude),
                        distanceKm: haversineKm(lat, lon, Number(h.latitude), Number(h.longitude))
                    }))
                    .filter(h => Number.isFinite(h.lat) && Number.isFinite(h.lon) && Number.isFinite(h.distanceKm) && h.distanceKm <= 10)
                    .sort((a, b) => a.distanceKm - b.distanceKm);

                regWithDistance.forEach(h => {
                    L.circleMarker([h.lat, h.lon], {
                        radius: 6,
                        color: '#d9534f',
                        fillColor: '#d9534f',
                        fillOpacity: 0.6,
                        weight: 2
                    }).addTo(registeredLayer).bindPopup(
                        `<strong>Registered Hospital</strong><br/><strong>${h.name}</strong><br/>${h.address ? h.address + '<br/>' : ''}${h.distanceKm.toFixed(1)} km away`
                    );
                });

                statusEl.textContent = `Showing ${Math.min(5, osmWithDistanceAll.length)} of ${osmWithDistanceAll.length} hospitals within 1 km.`;
                const bounds = L.latLngBounds([[lat, lon]]);
                osmWithDistanceAll.forEach(h => bounds.extend([h.lat, h.lon]));
                regWithDistance.forEach(h => bounds.extend([h.lat, h.lon]));
                map.fitBounds(bounds.pad(0.15));

                function renderList(limit) {
                    listEl.innerHTML = '';
                    const items = osmWithDistanceAll.slice(0, limit);
                    items.forEach((h, idx) => {
                        const row = document.createElement('div');
                        row.style.padding = '8px 0';
                        row.style.borderBottom = '1px solid #eee';
                        row.innerHTML = `
                            <div class="clearfix">
                                <div class="pull-left"><strong>${idx + 1}. ${h.name}</strong><br><small style="color:#777;">${h.address || 'Address unavailable'}</small></div>
                                <div class="pull-right"><strong>${h.distanceKm.toFixed(1)} km</strong></div>
                            </div>
                        `;
                        listEl.appendChild(row);
                    });
                }

                renderList(5);
                if (osmWithDistanceAll.length > 5) {
                    viewAllBtn.style.display = 'inline-block';
                    viewAllBtn.onclick = function () {
                        renderList(osmWithDistanceAll.length);
                        viewAllBtn.style.display = 'none';
                    };
                } else {
                    viewAllBtn.style.display = 'none';
                }
            } catch (e) {
                statusEl.textContent = 'Could not load nearby hospitals right now.';
            }
        }

        function setPatientPosition(lat, lon) {
            patientMarker.setLatLng([lat, lon]);
            map.setView([lat, lon], 12);
        }

        window.addEventListener('lifeline:location', async (ev) => {
            const lat = ev.detail && typeof ev.detail.lat === 'number' ? ev.detail.lat : null;
            const lon = ev.detail && typeof ev.detail.lon === 'number' ? ev.detail.lon : null;
            if (lat === null || lon === null) return;
            setPatientPosition(lat, lon);
            await loadHospitals(lat, lon);
        });

        if (updateBtn) {
            updateBtn.addEventListener('click', () => {
                statusEl.textContent = 'Fetching your location…';
                if (!navigator.geolocation) {
                    statusEl.textContent = 'Location is not supported in this browser.';
                    return;
                }
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    try { await persistUserLocation(lat, lon); } catch (e) { /* ignore */ }
                    try { localStorage.setItem('lifeline_last_location', JSON.stringify({ lat, lon, ts: Date.now() })); } catch (e) { /* ignore */ }
                    window.dispatchEvent(new CustomEvent('lifeline:location', { detail: { lat, lon, ts: Date.now() } }));
                }, () => {
                    statusEl.textContent = 'Location permission denied or unavailable.';
                }, { enableHighAccuracy: true, timeout: 8000 });
            });
        }

        loadHospitals(fallbackLat, fallbackLon);
    })();
</script>
{% endblock %}
